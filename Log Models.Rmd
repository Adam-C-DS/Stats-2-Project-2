---
title: "LogReg Modeling"
author: "Adam Canton"
date: "7/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(dplyr)
library(tidyverse)
library(olsrr)
library(ggplot2)
library(ggcorrplot)
library(GGally)
library(naniar)
library(reshape2)
library(ggthemes)
library(cowplot)
library(aod)
library(ROCR)
library(MASS)
library(caret)
library(e1071)
library(glmnet)
library(ROCR)
```


```{r}
# Grab the file Bank Additional Full - Fill in your file
BankAF <- read.csv(file = "F:/R For Real/Stats-2-Project-2/bank-additional-full.csv", sep = ";", header = TRUE)

# Change the name of the response from y to Subscription
names(BankAF)[21] <- "Subscription"

# Creating an ID column to spot check train test set data
ID <- seq(1,41188,1)
BankAF <- cbind(BankAF, ID)
#BankAF <- BankAF %>% mutate(SubNum = ifelse(Subscription == 'yes',1,0))
#Maybe a new categorical for pdays: New contact v Old contact - this might be captured in previous

# Going to try to create 2 data sets, one for Subscription-yes one for Subscription-no, Sample each one proportionally then recombine into train and test sets
BankAF.yes <- subset(BankAF, Subscription == "yes")
BankAF.no <- subset(BankAF, Subscription == "no")

```

```{r}
# Create Train and Test sets ----
## currently train is close to 75/25,
set.seed(35)
index.yes<-sample(1:dim(BankAF.yes)[1],floor(0.98*dim(BankAF.yes)),replace=F)
train.yes<-BankAF.yes[index.yes,]
test.yes<-BankAF.yes[-index.yes,]

index.no<-sample(1:dim(BankAF.no)[1],floor(0.3*dim(BankAF.no)),replace=F)
train.no<-BankAF.no[index.no,]
test.no<-BankAF.no[-index.no,]

BankAF.train <- rbind(train.no, train.yes)
BankAF.test <- rbind(test.no, test.yes)

# Getting rid of duration  - it will predict nearly perfectly - with this in mean prediction error = 0
# Also have to get rid of ID since it was being selected as good explanatory variable
BankAF.train = BankAF.train %>% dplyr::select(-c(duration, ID))
BankAF.test = BankAF.test %>% dplyr::select(-c(duration, ID))

# remove intermediate data sets
rm(test.no, test.yes, train.no, train.yes, BankAF.no, BankAF.yes)
```

```{r}
full.log <- glm(Subscription ~ ., family = 'binomial', data = BankAF.train)
step.log <- full.log %>% stepAIC(trace = FALSE)
```


```{r}
# Build Lasso Model on train set
Bank.Train.x <- model.matrix(Subscription ~ pdays + emp.var.rate + job + previous + cons.price.idx + cons.conf.idx + euribor3m + nr.employed
                             + education + default + contact + poutcome + month, BankAF.train)
Bank.Train.y <- BankAF.train[,20]

cvfit <- cv.glmnet(Bank.Train.x, Bank.Train.y, family = "binomial", type.measure = "class", nlambda = 1000)

plot(cvfit)
coef(cvfit, s = "lambda.min")

# Cv Missclassification
print("Cv Error Rate:")
cvfit$cvm[which(cvfit$lambda==cvfit$lambda.min)]


# Optimal Penalty
print("Penalty Value:")
cvfit$lambda.min

# Final Model
finalmodel <- glmnet(Bank.Train.x, Bank.Train.y, family = "binomial", lambda = cvfit$lambda.min)
```


```{r}
# Get predictions from Lasso Model on Test set
Bank.Test.x <- model.matrix(Subscription ~ pdays + emp.var.rate + job + previous + cons.price.idx + cons.conf.idx + euribor3m + nr.employed
                             + education + default + contact + poutcome + month, BankAF.test)

fit.pred.lasso <- predict(finalmodel, newx = Bank.Test.x, type = "response")

BankAF.test$Subscription[1:15]
fit.pred.lasso[1:15]

fit.pred.step <- predict(step.log, newdata = BankAF.test, type= "response")
```

```{r}
cutoff.lasso <- 0.4
cutoff.step <- 0.4

class.lasso <- factor(ifelse(fit.pred.lasso > cutoff.lasso, 'yes','no'),levels = c('no','yes'))
class.step <- factor(ifelse(fit.pred.step > cutoff.step, 'yes','no'),levels = c('no','yes'))

print("Confusion Lasso")
confusionMatrix(class.lasso, BankAF.test$Subscription)
cat("**********************************************\n**********************************************\n\n")
print("Confusion Step")
confusionMatrix(class.step, BankAF.test$Subscription)
```

```{r}
simple.log<-glm(Subscription ~ poutcome + emp.var.rate + contact + nr.employed + cons.price.idx + cons.conf.idx + emp.var.rate*poutcome + contact*day_of_week 
                ,family="binomial",data=BankAF.train)

fit.pred.origin<-predict(simple.log,newdata=BankAF.test,type="response")

results.origin<-prediction(fit.pred.origin,BankAF.test$Subscription,label.ordering=c("no","yes"))

roc.origin=performance(results.origin,measure = "tnr", x.measure = "fnr")
```

```{r}

# Get results from predictions
results.lasso <- prediction(fit.pred.lasso, BankAF.test$Subscription,label.ordering=c("no","yes"))
results.step <- prediction(fit.pred.step, BankAF.test$Subscription,label.ordering=c("no","yes")) 

# look at performance metrics of above predictions
roc.lasso = performance(results.lasso, measure = "tnr", x.measure = "fnr")
roc.step = performance(results.step, measure = "tnr", x.measure = 'fnr')

plot(roc.lasso, col = "red", lty = 1, main = "ROC")
plot(roc.step, col = "blue1", lty = 1, add = TRUE)
plot(roc.origin, col = "darkgreen", lty = 1, add = TRUE)
abline(a=0, b= 1)
legend("bottomright",legend=c("Lasso","Stepwise","Trial"),col=c("red","blue","green"),lty=1,lwd=1)
abline(a=0, b= 1)
```

```{r}

```

















